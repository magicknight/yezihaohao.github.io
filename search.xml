<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
    
    <entry>
      <title><![CDATA[Nodejs爬虫--抓取豆瓣电影网页数据（下）]]></title>
      <url>http://yoursite.com/2017/02/11/Nodejs%E7%88%AC%E8%99%AB-%E6%8A%93%E5%8F%96%E8%B1%86%E7%93%A3%E7%94%B5%E5%BD%B1%E7%BD%91%E9%A1%B5%E6%95%B0%E6%8D%AE%EF%BC%88%E4%B8%8B%EF%BC%89/</url>
      <content type="html"><![CDATA[<blockquote>
<p>接着上篇 <a href="https://yezihaohao.github.io/2017/02/09/Nodejs%E7%88%AC%E8%99%AB-%E6%8A%93%E5%8F%96%E8%B1%86%E7%93%A3%E7%94%B5%E5%BD%B1%E7%BD%91%E9%A1%B5%E6%95%B0%E6%8D%AE%EF%BC%88%E4%B8%8A%EF%BC%89/" target="_blank" rel="external">Nodejs爬虫–抓取豆瓣电影网页数据（上）</a><br>  本篇主要描述将上次抓取的数据存入mongodb数据库<br>  前提：百度或谷歌mongodb的安装教程，安装本地并成功运行<br>  推荐一款mongodb数据库可视化管理工具：Robomongo。可以加群264591039获取安装包或自行寻找资源</p>
</blockquote>
<h3 id="首先用npm安装第三方数据库操作包：mongoose"><a href="#首先用npm安装第三方数据库操作包：mongoose" class="headerlink" title="首先用npm安装第三方数据库操作包：mongoose."></a>首先用npm安装第三方数据库操作包：mongoose.</h3><p>关于mongoose详情请查看<a href="http://mongoosejs.com/index.html" target="_blank" rel="external">官方文档</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install --save-dev mongoose</div></pre></td></tr></table></figure></p>
<h3 id="引入mongoose包开始对mongodb进行管理"><a href="#引入mongoose包开始对mongodb进行管理" class="headerlink" title="引入mongoose包开始对mongodb进行管理"></a>引入mongoose包开始对mongodb进行管理</h3><p>当前目录下新建一个mongo.js文件方便管理，在该文件中引入相关包：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">let</span> mongoose = require(<span class="string">'mongoose'</span>),</div><div class="line">    assert = require(<span class="string">'assert'</span>);</div></pre></td></tr></table></figure></p>
<a id="more"></a>
<h3 id="获取表构造器Schema并映射mongodb相应的collection"><a href="#获取表构造器Schema并映射mongodb相应的collection" class="headerlink" title="获取表构造器Schema并映射mongodb相应的collection"></a>获取表构造器Schema并映射mongodb相应的collection</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">let</span> Schema = mongoose.Schema;</div><div class="line"></div><div class="line"><span class="built_in">let</span> filmSchema = new Schema(&#123;       //自定义相应的表数据字段</div><div class="line">        title: String,</div><div class="line">        <span class="built_in">type</span>: String,</div><div class="line">        directories: String,</div><div class="line">        scriptwriter: String,</div><div class="line">        actors: String</div><div class="line">    &#125;);</div><div class="line">//映射collection并生成model对象用于管理数据表的增删改查</div><div class="line">//默认是映射到名为films的collection</div><div class="line">//若自定义表明则：<span class="built_in">let</span> filmSchema = new Schema(&#123;..&#125;, &#123; collection: <span class="string">'data'</span> &#125;);  <span class="string">'data'</span>即为自定义名称</div><div class="line"><span class="built_in">let</span> Film = mongoose.model(<span class="string">'Film'</span>, filmSchema);</div></pre></td></tr></table></figure>
<h3 id="连接mongodb数据库并exports-Film对象"><a href="#连接mongodb数据库并exports-Film对象" class="headerlink" title="连接mongodb数据库并exports Film对象"></a>连接mongodb数据库并exports Film对象</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">let</span> db = mongoose.connect(<span class="string">'mongodb://127.0.0.1:27017/spider'</span>);</div><div class="line">db.connection.on(<span class="string">'error'</span>, (err) =&gt; &#123;</div><div class="line">    console.log(`数据库连接失败：<span class="variable">$&#123;err&#125;</span>`);</div><div class="line">&#125;);</div><div class="line">db.connection.on(<span class="string">'open'</span>, () =&gt; &#123;</div><div class="line">    console.log(<span class="string">'数据库连接成功'</span>);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">module.exports = &#123;Film: Film&#125;;</div></pre></td></tr></table></figure>
<h3 id="在spider-js中引入Film对象并添加入库操作代码"><a href="#在spider-js中引入Film对象并添加入库操作代码" class="headerlink" title="在spider.js中引入Film对象并添加入库操作代码"></a>在spider.js中引入Film对象并添加入库操作代码</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">let</span> mongo = require(<span class="string">'./mongo'</span>);</div><div class="line">//在请求网页的end函数中添加入库操作</div><div class="line">xxxx.end((err, res) =&gt; &#123;</div><div class="line">    var $ = cheerio.load(res.text);     //用cheerio获取整个页面DOM对象</div><div class="line">    var _data = &#123;title:<span class="string">''</span>, <span class="built_in">type</span>: <span class="string">''</span>, directories: <span class="string">''</span>, scriptwriter: <span class="string">''</span>, actors: <span class="string">''</span>&#125;;</div><div class="line">    _data.title = $(<span class="string">'#content h1 span'</span>).text();</div><div class="line">    _data.directories = $(<span class="string">'#info .attrs'</span>).eq(0).text();</div><div class="line">    _data.scriptwriter = $(<span class="string">'#info .attrs'</span>).eq(1).text();</div><div class="line">    _data.actors = $(<span class="string">'#info .attrs'</span>).eq(2).text();</div><div class="line">    $(<span class="string">'span[property="v:genre"]'</span>).each(<span class="keyword">function</span> (index) &#123;</div><div class="line">        _data.type += ($(this).text() + (index == $(<span class="string">'span[property="v:genre"]'</span>).length - 1 ? <span class="string">''</span> : <span class="string">'、'</span>));</div><div class="line">    &#125;);</div><div class="line">    console.log(_data);</div><div class="line">    mongo.Film.create(_data, (err, doc) =&gt; &#123;</div><div class="line">                        assert.equal(err, null);</div><div class="line">                        console.log(doc);</div><div class="line">                    &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h3 id="运行spider-js，并查看数据库中的数据"><a href="#运行spider-js，并查看数据库中的数据" class="headerlink" title="运行spider.js，并查看数据库中的数据"></a>运行spider.js，并查看数据库中的数据</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">node spider.js</div><div class="line">//用上述提到的可视化工具查看数据库是否成功有数据入库</div></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/yezihaohao/yezihaohao.github.io/master/imgs/QQ%E6%88%AA%E5%9B%BE20170211120738.png" alt="数据库截图"></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Javascript正则表达式整合]]></title>
      <url>http://yoursite.com/2017/02/10/Javascript%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%95%B4%E5%90%88/</url>
      <content type="html"><![CDATA[<h2 id="项目中常用正则表达式使用整合大全"><a href="#项目中常用正则表达式使用整合大全" class="headerlink" title="项目中常用正则表达式使用整合大全"></a>项目中常用正则表达式使用整合大全</h2><h3 id="提取网页标签内容"><a href="#提取网页标签内容" class="headerlink" title="提取网页标签内容"></a>提取网页标签内容</h3><h4 id="一-单个标签提取"><a href="#一-单个标签提取" class="headerlink" title="一.单个标签提取"></a>一.单个标签提取</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">let</span> str = `&lt;a class=<span class="string">"menu"</span>&gt;GitHub&lt;/a&gt;`;</div><div class="line"></div><div class="line"><span class="built_in">let</span> content = str.match(/&lt;a class=<span class="string">"menu"</span>&gt;([\s\S]+)&lt;\/a&gt;/)[1];</div></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="不定时更新中…"><a href="#不定时更新中…" class="headerlink" title="不定时更新中…"></a>不定时更新中…</h2>]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Nodejs爬虫--抓取豆瓣电影网页数据（上）]]></title>
      <url>http://yoursite.com/2017/02/09/Nodejs%E7%88%AC%E8%99%AB-%E6%8A%93%E5%8F%96%E8%B1%86%E7%93%A3%E7%94%B5%E5%BD%B1%E7%BD%91%E9%A1%B5%E6%95%B0%E6%8D%AE%EF%BC%88%E4%B8%8A%EF%BC%89/</url>
      <content type="html"><![CDATA[<p>之前写了一个nodejs的开源爬虫小项目，补上博客详细解析下代码。</p>
<p><code>PS：</code>共有上下两篇，第一篇讲从网站上抓取数据，第二篇讲将抓取的数据存入mongodb数据库。</p>
<h2 id="我们快速开始吧"><a href="#我们快速开始吧" class="headerlink" title="我们快速开始吧"></a>我们快速开始吧</h2><h3 id="首先，安装nodejs，然后用npm工具初始化资源管理配置文件：package-json"><a href="#首先，安装nodejs，然后用npm工具初始化资源管理配置文件：package-json" class="headerlink" title="首先，安装nodejs，然后用npm工具初始化资源管理配置文件：package.json"></a>首先，安装nodejs，然后用npm工具初始化资源管理配置文件：package.json</h3><p>新建spider文件夹，在该文件夹下面初始化package.json<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm init</div></pre></td></tr></table></figure></p>
<h3 id="然后用npm安装相关库文件："><a href="#然后用npm安装相关库文件：" class="headerlink" title="然后用npm安装相关库文件："></a>然后用npm安装相关库文件：</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install --save-dev superagent cheerio eventproxy <span class="keyword">async</span></div></pre></td></tr></table></figure>
<p>在文件夹下面新建spider.js, 在文件中引入需要用到的nodejs模块如下(具体用法请查询网上相关资料)：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> superagent = <span class="built_in">require</span>(<span class="string">'superagent'</span>),     <span class="comment">//nodejs里面一个非常方便的客户端代理请求模块，支持get,post,put,delete等</span></div><div class="line">    cheerio = <span class="built_in">require</span>(<span class="string">'cheerio'</span>),           <span class="comment">//类似于jQuery的DOM操作模块，可以提取html中想要的信息</span></div><div class="line">    eventproxy = <span class="built_in">require</span>(<span class="string">'eventproxy'</span>),     <span class="comment">//控制异步请求并发，可以监听请求，使得某些请求完毕之后在发送请求</span></div><div class="line">    assert = <span class="built_in">require</span>(<span class="string">'assert'</span>),             <span class="comment">//异常抛出判断模块，assert.equal(err, null);  如果err不为null,则直接抛出异常</span></div><div class="line">    <span class="keyword">async</span> = <span class="built_in">require</span>(<span class="string">'async'</span>);              <span class="comment">//控制请求并发连接数</span></div></pre></td></tr></table></figure></p>
<a id="more"></a>
<h3 id="用superagent请求豆瓣的某个接口，并把所有的页面链接放到一个数组里面，用eventproxy控制监听该请求结束之后才开始请求相应的详情页面。"><a href="#用superagent请求豆瓣的某个接口，并把所有的页面链接放到一个数组里面，用eventproxy控制监听该请求结束之后才开始请求相应的详情页面。" class="headerlink" title="用superagent请求豆瓣的某个接口，并把所有的页面链接放到一个数组里面，用eventproxy控制监听该请求结束之后才开始请求相应的详情页面。"></a>用superagent请求豆瓣的某个接口，并把所有的页面链接放到一个数组里面，用eventproxy控制监听该请求结束之后才开始请求相应的详情页面。</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">superagent.get(URL)</div><div class="line">    .end(<span class="function">(<span class="params">err, res</span>) =&gt;</span> &#123;</div><div class="line">        <span class="keyword">let</span> _pageUrls = [];</div><div class="line">        res.body.forEach(<span class="function">(<span class="params">val</span>) =&gt;</span> &#123;</div><div class="line">           _pageUrls.push(val.url);</div><div class="line">        &#125;);</div><div class="line">        ep.emit(<span class="string">'pageUrls'</span>, _pageUrls);   <span class="comment">//监听相关实例，完成之后告诉pageUrls</span></div><div class="line">    &#125;)</div></pre></td></tr></table></figure>
<h3 id="监听事件完成之后，执行请求相应的豆瓣电影详情页面-并用async控制请求的并发量，可以降低请求的频率和速度"><a href="#监听事件完成之后，执行请求相应的豆瓣电影详情页面-并用async控制请求的并发量，可以降低请求的频率和速度" class="headerlink" title="监听事件完成之后，执行请求相应的豆瓣电影详情页面.并用async控制请求的并发量，可以降低请求的频率和速度"></a>监听事件完成之后，执行请求相应的豆瓣电影详情页面.并用async控制请求的并发量，可以降低请求的频率和速度</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> ep = eventproxy.create(<span class="string">'pageUrls'</span>, (pageUrls) =&gt; &#123;      <span class="comment">//创建一个监听实例</span></div><div class="line">    <span class="keyword">let</span> _http = <span class="function">(<span class="params">url, callback</span>) =&gt;</span> &#123;</div><div class="line">        <span class="keyword">let</span> _delay = <span class="built_in">parseInt</span>((<span class="built_in">Math</span>.random() * <span class="number">30000000</span>) % <span class="number">1000</span>, <span class="number">10</span>);   <span class="comment">//随机延时请求</span></div><div class="line">        superagent.get(url)</div><div class="line">            .end(<span class="function">(<span class="params">err, res</span>) =&gt;</span> &#123;</div><div class="line">                <span class="keyword">var</span> $ = cheerio.load(res.text);     <span class="comment">//用cheerio获取整个页面DOM对象</span></div><div class="line">                <span class="keyword">var</span> _data = &#123;<span class="attr">title</span>:<span class="string">''</span>, <span class="attr">type</span>: <span class="string">''</span>, <span class="attr">directories</span>: <span class="string">''</span>, <span class="attr">scriptwriter</span>: <span class="string">''</span>, <span class="attr">actors</span>: <span class="string">''</span>&#125;;</div><div class="line">                _data.title = $(<span class="string">'#content h1 span'</span>).text();</div><div class="line">                _data.directories = $(<span class="string">'#info .attrs'</span>).eq(<span class="number">0</span>).text();</div><div class="line">                _data.scriptwriter = $(<span class="string">'#info .attrs'</span>).eq(<span class="number">1</span>).text();</div><div class="line">                _data.actors = $(<span class="string">'#info .attrs'</span>).eq(<span class="number">2</span>).text();</div><div class="line">                $(<span class="string">'span[property="v:genre"]'</span>).each(<span class="function"><span class="keyword">function</span> (<span class="params">index</span>) </span>&#123;</div><div class="line">                    _data.type += ($(<span class="keyword">this</span>).text() + (index == $(<span class="string">'span[property="v:genre"]'</span>).length - <span class="number">1</span> ? <span class="string">''</span> : <span class="string">'、'</span>));</div><div class="line">                &#125;);</div><div class="line">                <span class="built_in">console</span>.log(_data);</div><div class="line">            &#125;);</div><div class="line">        setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">            callback(<span class="literal">null</span>, url);</div><div class="line">        &#125;, _delay);</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="keyword">async</span>.mapLimit(pageUrls, <span class="number">3</span>, (url, callback) =&gt; &#123;  <span class="comment">//用async 的 mapLimit(arr, limit, iterator, callback) 接口控制请求并发量为3</span></div><div class="line">        _http(url, callback);</div><div class="line">    &#125;, (err, res) =&gt; &#123;</div><div class="line">        assert.equal(err, <span class="literal">null</span>);</div><div class="line">    &#125;)</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h2 id="本章节结束，未完待续…下期是怎么将抓取的数据存入mongodb数据库！"><a href="#本章节结束，未完待续…下期是怎么将抓取的数据存入mongodb数据库！" class="headerlink" title="本章节结束，未完待续…下期是怎么将抓取的数据存入mongodb数据库！"></a>本章节结束，未完待续…下期是怎么将抓取的数据存入mongodb数据库！</h2>]]></content>
    </entry>
    
  
  
</search>
